# -*- coding: utf-8 -*-
"""Untitled5.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1qm_q9kHymxdKjDUaUQNae5lZKXCY6AN6
"""

import gradio as gr
import tensorflow as tf
from tensorflow.keras.models import load_model
import numpy as np
from PIL import Image

# ğŸ”¹ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
model = load_model("best_model_fold_5.keras")

# âœ… Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù† Ø§Ù„ØµÙˆØ±Ø© Ø´ÙƒÙ„Ù‡Ø§ X-ray (ØªØ¨Ø§ÙŠÙ† Ù…Ù†Ø®ÙØ¶)
def is_xray_like(image_array):
    std = np.std(image_array)
    return std < 0.25  # Ù…Ù…ÙƒÙ† ØªØ¹Ø¯Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªØ´Ø¯Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚

# ğŸ”¹ Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨Ø¤
def predict_bone_age(image, sex):
    image = image.resize((299, 299))
    image_array = np.array(image).astype("float32") / 255.0

    if image_array.shape[-1] == 4:
        image_array = image_array[..., :3]

    # âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù† Ø§Ù„ØµÙˆØ±Ø© X-ray
    if not is_xray_like(image_array):
        return "âŒ Please upload a valid grayscale hand X-ray image."

    image_array = np.expand_dims(image_array, axis=0)
    sex_array = np.array([[sex]])

    prediction = model.predict([image_array, sex_array])[0][0]
    predicted_age_months = prediction * 240
    predicted_age_years = predicted_age_months / 12

    return f"ğŸ¦´ Estimated Bone Age:\n\n**{predicted_age_months:.2f} months**\n**{predicted_age_years:.2f} years**"

# ğŸ”¹ ÙˆØµÙ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
description_text = """
Upload a hand X-ray and select the biological sex to estimate bone age using an AI model trained on Xception architecture.
"""

# ğŸ”¹ Gradio ÙˆØ§Ø¬Ù‡Ø©
interface = gr.Interface(
    fn=predict_bone_age,
    inputs=[
        gr.Image(type="pil", label="ğŸ“· Hand X-ray Image"),
        gr.Radio(choices=[("ğŸ‘¨ Male", 1), ("ğŸ‘© Female", 0)], label="âš¥ Sex", value=1)
    ],
    outputs=gr.Markdown(label="ğŸ” Result"),
    title="Bone Age Prediction with Xception",
    description=description_text,
)

# ğŸ”¹ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
interface.launch()